<script>
// ==========================
// FIREBASE CONFIG
// ==========================
const firebaseConfig = {
  apiKey: "AIzaSyCaQq-aQ5kj2TdvccyejdjNTcZvViKIncY",
  authDomain: "nutriapp-2eeb3.firebaseapp.com",
  projectId: "nutriapp-2eeb3",
  storageBucket: "nutriapp-2eeb3.firebasestorage.app",
  messagingSenderId: "7989666043",
  appId: "1:7989666043:web:97c20b6a3c963703d4105e"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// Persistencia REAL en iOS PWA
auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

// ==========================
// VARIABLES
// ==========================
const dias = ["Lunes","Martes","Miércoles","Jueves","Viernes","Sábado","Domingo"];
const diaEl = document.getElementById('dia');
dias.forEach(d => diaEl.innerHTML += `<option value="${d}">${d}</option>`);

// ==========================
// AUTH EMAIL LOGIN
// ==========================
document.getElementById('loginBtn').onclick = () => {
  auth.signInWithEmailAndPassword(email.value, password.value)
    .catch(error => {
      loginError.style.display = 'block';
      loginError.innerText = error.message;
    });
};

// ==========================
// AUTH REGISTER
// ==========================
document.getElementById('registerBtn').onclick = () => {
  auth.createUserWithEmailAndPassword(email.value, password.value)
    .then(() => {
      alert("Cuenta creada correctamente");
    })
    .catch(error => {
      loginError.style.display = 'block';
      loginError.innerText = error.message;
    });
};

// ==========================
// AUTH GOOGLE (REDIRECT PARA iOS)
// ==========================
document.getElementById('googleBtn').onclick = async () => {
  const provider = new firebase.auth.GoogleAuthProvider();
  provider.setCustomParameters({ prompt: 'select_account' });

  try {
    await auth.signInWithRedirect(provider);
  } catch (error) {
    loginError.style.display = 'block';
    loginError.innerText = error.message;
  }
};

// ==========================
// LOGOUT
// ==========================
document.getElementById('logoutBtn').onclick = () => auth.signOut();

// ==========================
// AUTH STATE LISTENER
// ==========================
auth.onAuthStateChanged(user => {
  if (user) {
    loginScreen.classList.add('hidden');
    app.classList.remove('hidden');
    loadPlan();
  } else {
    loginScreen.classList.remove('hidden');
    app.classList.add('hidden');
  }
});

// ==========================
// SAVE PLAN
// ==========================
async function savePlan() {
  const user = auth.currentUser;
  if (!user) return;

  await db.collection("plans").doc(user.uid).set({
    [perfil.value + dia.value]: {
      Desayuno: desayuno.value,
      Comida: comida.value,
      Cena: cena.value
    }
  }, { merge: true });

  loadPlan();
}

// ==========================
// LOAD PLAN
// ==========================
async function loadPlan() {
  const user = auth.currentUser;
  if (!user) return;

  const doc = await db.collection("plans").doc(user.uid).get();
  renderHome(doc.exists ? doc.data() : {});
}

// ==========================
// RENDER HOME
// ==========================
function renderHome(data = {}) {
  let perfilSel = perfilHome.value;
  let html = '<table><tr><th></th>';
  dias.forEach(d => html += `<th>${d}</th>`);
  html += '</tr>';

  ['Desayuno','Comida','Cena'].forEach(tipo => {
    html += `<tr><th>${tipo}</th>`;
    dias.forEach(d => {
      let key = perfilSel + d;
      let cell = data[key] ? data[key][tipo] : '';
      html += `<td>${cell || ''}</td>`;
    });
    html += '</tr>';
  });

  html += '</table>';
  tablaSemanal.innerHTML = html;
}

perfilHome.onchange = loadPlan;
document.getElementById('guardarBtn').onclick = savePlan;

// ==========================
// NAVIGATION
// ==========================
document.getElementById('tabHome').onclick = () => {
  home.classList.remove('hidden');
  plan.classList.add('hidden');
};

document.getElementById('tabPlan').onclick = () => {
  home.classList.add('hidden');
  plan.classList.remove('hidden');
};

// ==========================
// SERVICE WORKER
// ==========================
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('./service-worker.js');
  });
}

</script>
